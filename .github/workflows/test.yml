name: Test

on:
  push:
    paths:
      - "**.cs"
      - "**.csproj"
      - "c-wspp-rs/**"
      - ".github/workflows/test.yml"
  pull_request:
    paths:
      - "**.cs"
      - "**.csproj"
      - "c-wspp-rs/**"
      - ".github/workflows/test.yml"

jobs:
  test-windows:
    strategy:
      fail-fast: false
      matrix:
        tgt: ["net35", "net8"]

    name: test-windows ${{ matrix.tgt }}
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Restore + clean
        run: |
          dotnet restore
          dotnet clean

      - name: Build wsmini server
        run: |
          dotnet build .\test\wsmini.csproj -c Debug -f net8.0

      - name: Build wstest
        run: |
          dotnet build .\test\wstest.csproj -c Debug -f ${{ matrix.tgt }}

      - name: Run integration test against local wsmini
        shell: pwsh
        run: |
          $server = Start-Process dotnet -ArgumentList ".\test\bin\Debug\net8.0\wsmini.dll" -PassThru -WindowStyle Hidden
          try {
            $ready = $false
            for ($i = 0; $i -lt 40; $i++) {
              try {
                Invoke-WebRequest "http://127.0.0.1:18765/" -UseBasicParsing | Out-Null
                $ready = $true
                break
              } catch {
                Start-Sleep -Milliseconds 250
              }
            }
            if (-not $ready) { throw "wsmini server did not start in time" }

            if ("${{ matrix.tgt }}" -eq "net35") {
              & ".\test\bin\Debug\net35\wstest.exe" "" "ws://127.0.0.1:18765/ws"
            } else {
              dotnet ".\test\bin\Debug\net8\wstest.dll" "" "ws://127.0.0.1:18765/ws"
            }
          } finally {
            if ($server -and -not $server.HasExited) {
              Stop-Process -Id $server.Id -Force
            }
          }

  test-linux:
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-22.04", "ubuntu-24.04"]
        tgt: ["net35", "net8"]

    name: test-linux ${{ matrix.os }} ${{ matrix.tgt }}
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Setup mono
        if: ${{ matrix.tgt == 'net35' }}
        run: |
          sudo apt update -y
          sudo apt install mono-complete -y

      - name: Restore + clean
        run: |
          dotnet restore
          dotnet clean

      - name: Build wsmini server
        run: |
          dotnet build ./test/wsmini.csproj -c Debug -f net8.0

      - name: Build wstest
        run: |
          dotnet build ./test/wstest.csproj -c Debug -f ${{ matrix.tgt }}

      - name: Run integration test against local wsmini
        shell: bash
        run: |
          set -euo pipefail
          dotnet ./test/bin/Debug/net8.0/wsmini.dll > wsmini.log 2>&1 &
          SERVER_PID=$!
          trap 'kill $SERVER_PID || true' EXIT

          for i in $(seq 1 40); do
            if curl -fsS http://127.0.0.1:18765/ >/dev/null; then
              break
            fi
            sleep 0.25
          done

          if [[ "${{ matrix.tgt }}" == "net35" ]]; then
            mono ./test/bin/Debug/net35/wstest.exe "" "ws://127.0.0.1:18765/ws"
          else
            dotnet ./test/bin/Debug/net8/wstest.dll "" "ws://127.0.0.1:18765/ws"
          fi

  test-macos:
    strategy:
      fail-fast: false
      matrix:
        tgt: ["net8"]

    name: test-macos ${{ matrix.tgt }}
    runs-on: macos-15

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Restore + clean
        run: |
          dotnet restore
          dotnet clean

      - name: Build wsmini server
        run: |
          dotnet build ./test/wsmini.csproj -c Debug -f net8.0

      - name: Build wstest
        run: |
          dotnet build ./test/wstest.csproj -c Debug -f ${{ matrix.tgt }}

      - name: Run integration test against local wsmini
        shell: bash
        run: |
          set -euo pipefail
          dotnet ./test/bin/Debug/net8.0/wsmini.dll > wsmini.log 2>&1 &
          SERVER_PID=$!
          trap 'kill $SERVER_PID || true' EXIT

          for i in $(seq 1 40); do
            if curl -fsS http://127.0.0.1:18765/ >/dev/null; then
              break
            fi
            sleep 0.25
          done

          dotnet ./test/bin/Debug/net8/wstest.dll "" "ws://127.0.0.1:18765/ws"
