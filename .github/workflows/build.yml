name: Build

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"
      - "!*norel*"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: windows-latest
            os_id: windows-x64
          - runner: ubuntu-24.04
            os_id: linux-x64
          - runner: macos-13
            os_id: macos-x64
          - runner: macos-15
            os_id: macos-arm64
        tfm: ["netstandard2.0", "net35"]

    name: build ${{ matrix.os_id }} ${{ matrix.tfm }}
    runs-on: ${{ matrix.runner }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Restore + clean
        run: |
          dotnet restore
          dotnet clean

      - name: Build websocket-sharp
        run: |
          dotnet build ./websocket-sharp/websocket-sharp.csproj -c Release -f ${{ matrix.tfm }}

      - name: Prepare package metadata
        id: meta
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}"
          if ([string]::IsNullOrWhiteSpace($version) -or $version -eq "refs/heads/main") {
            $version = "dev-${{ github.run_number }}"
          }
          $zipName = "c-wspp-websocket-sharp_${version}_${{ matrix.os_id }}_${{ matrix.tfm }}.zip"
          "zip_name=$zipName" >> $env:GITHUB_OUTPUT

      - name: Create zip bundle
        shell: pwsh
        run: |
          $src = Join-Path $PWD "websocket-sharp/bin/Release/${{ matrix.tfm }}"
          $dstDir = Join-Path $PWD "build"
          New-Item -ItemType Directory -Force -Path $dstDir | Out-Null
          $zipPath = Join-Path $dstDir "${{ steps.meta.outputs.zip_name }}"
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path (Join-Path $src '*') -DestinationPath $zipPath -Force
          Write-Host "Created $zipPath"

      - name: Upload zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.zip_name }}
          path: build/${{ steps.meta.outputs.zip_name }}
          if-no-files-found: error
