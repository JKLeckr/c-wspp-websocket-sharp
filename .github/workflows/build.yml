name: Build

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Tag to publish draft release assets to (required for manual runs)"
        required: false
        type: string
  push:
    tags:
      - "v*"
      - "!*norel*"

jobs:
  prepare-release:
    name: prepare-release
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    outputs:
      release_tag: ${{ steps.meta.outputs.release_tag }}

    steps:
      - name: Resolve release tag
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            TAG="${GITHUB_REF_NAME}"
          else
            TAG="${{ github.event.inputs.release_tag }}"
          fi
          if [[ -z "${TAG}" ]]; then
            echo "No release tag available. For workflow_dispatch, provide inputs.release_tag."
            exit 1
          fi
          echo "release_tag=${TAG}" >> "${GITHUB_OUTPUT}"

      - name: Create draft release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.release_tag }}
          draft: true
          prerelease: false
          name: c-wspp-websocket-sharp ${{ steps.meta.outputs.release_tag }}
          token: ${{ secrets.CWSPP_WEBSOCKET_SHARP_TOKEN }}

      - name: Prepare Rust tools
        uses: baptiste0928/cargo-install@v3
        with:
          crate: cargo-bundle-licenses


  build-windows:
    strategy:
      fail-fast: false
      matrix:
        os:
          - {managed_arch: x64, os_id: windows-x64, rid_dir: win-x64}
        tfm: ["netstandard2.0", "net35"]
        include:
          - os: {managed_arch: x86, os_id: windows-x86, rid_dir: win-x86}
            tfm: "net35"

    name: build-windows ${{ matrix.os.os_id }} ${{ matrix.tfm }}
    runs-on: windows-latest
    needs: prepare-release
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Setup Rust tools
        uses: baptiste0928/cargo-install@v3
        with:
          crate: cargo-bundle-licenses

      - name: Setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Restore + clean
        run: |
          dotnet restore
          dotnet clean

      - name: Build websocket-sharp
        run: |
          dotnet build .\websocket-sharp\websocket-sharp.csproj -c Release -f ${{ matrix.tfm }} --arch ${{ matrix.os.managed_arch }}

      - name: Generate c-wspp-rs third-party license manifest
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path .\build\licenses | Out-Null
          Push-Location .\c-wspp-rs
          cargo bundle-licenses --format yaml --output ..\build\licenses\cwspp-rs-THIRDPARTY.yaml
          Pop-Location

      - name: Create zip bundle
        id: pack
        shell: pwsh
        run: |
          $tag = "${{ needs.prepare-release.outputs.release_tag }}"
          $osId = "${{ matrix.os.os_id }}"
          $tfm = "${{ matrix.tfm }}"
          $ridDir = "${{ matrix.os.rid_dir }}"
          $name = "c-wspp-websocket-sharp_${tag}_${osId}_${tfm}"
          $zipName = "$name.zip"

          $src = Join-Path $PWD "websocket-sharp/bin/Release/$tfm/$ridDir"
          $buildDir = Join-Path $PWD "build"
          $pkgDir = Join-Path $buildDir $name
          $zipPath = Join-Path $buildDir $zipName

          if (Test-Path $pkgDir) { Remove-Item $pkgDir -Recurse -Force }
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          New-Item -ItemType Directory -Force -Path $pkgDir | Out-Null

          Copy-Item (Join-Path $src '*') -Destination $pkgDir -Recurse -Force
          $licDir = Join-Path $pkgDir "licenses"
          New-Item -ItemType Directory -Force -Path $licDir | Out-Null
          Copy-Item ".\LICENSE.txt" -Destination (Join-Path $licDir "LICENSE.txt") -Force
          Copy-Item ".\c-wspp-rs\LICENSE" -Destination (Join-Path $licDir "LICENSE.c-wspp-rs.txt") -Force
          Copy-Item ".\c-wspp-rs\LICENSE.3rd-party.txt" -Destination (Join-Path $licDir "LICENSE.c-wspp-rs.3rd-party.txt") -Force
          Copy-Item ".\build\licenses\cwspp-rs-THIRDPARTY.yaml" -Destination (Join-Path $licDir "cwspp-rs-THIRDPARTY.yaml") -Force
          @(
            "LICENSE.txt",
            "LICENSE.c-wspp-rs.txt",
            "LICENSE.c-wspp-rs.3rd-party.txt",
            "LICENSE.3rd-party.txt",
            "cwspp-rs-THIRDPARTY.yaml"
          ) | ForEach-Object {
            $rootFile = Join-Path $pkgDir $_
            if (Test-Path $rootFile) { Remove-Item $rootFile -Force }
          }
          Compress-Archive -Path $pkgDir -DestinationPath $zipPath -Force

          "zip_path=$zipPath" >> $env:GITHUB_OUTPUT

      - name: Upload zip to draft release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.release_tag }}
          draft: true
          prerelease: false
          name: c-wspp-websocket-sharp ${{ needs.prepare-release.outputs.release_tag }}
          token: ${{ secrets.CWSPP_WEBSOCKET_SHARP_TOKEN }}
          files: |
              ${{ steps.pack.outputs.zip_path }}

  build-linux:
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-24.04"]
        tfm: ["netstandard2.0", "net35"]
        include:
          - os: "ubuntu-22.04"
            tfm: "net35"

    name: build-linux ${{ matrix.os }} ${{ matrix.tfm }}
    runs-on: ${{ matrix.os }}
    needs: prepare-release
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Setup Rust tools
        uses: baptiste0928/cargo-install@v3
        with:
          crate: cargo-bundle-licenses

      - name: Setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Setup mono
        if: ${{ matrix.tfm == 'net35' }}
        run: |
          sudo apt update -y
          sudo apt install mono-complete -y

      - name: Restore + clean
        run: |
          dotnet restore
          dotnet clean

      - name: Build websocket-sharp
        run: |
          dotnet build ./websocket-sharp/websocket-sharp.csproj -c Release -f ${{ matrix.tfm }}

      - name: Generate c-wspp-rs third-party license manifest
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build/licenses
          (
            cd c-wspp-rs
            cargo bundle-licenses --format yaml --output ../build/licenses/cwspp-rs-THIRDPARTY.yaml
          )

      - name: Create zip bundle
        id: pack
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ needs.prepare-release.outputs.release_tag }}"
          OS_ID="${{ matrix.os }}"
          TFM="${{ matrix.tfm }}"
          NAME="c-wspp-websocket-sharp_${TAG}_${OS_ID}_${TFM}"
          ZIP_NAME="${NAME}.zip"

          SRC="websocket-sharp/bin/Release/${TFM}"
          BUILD_DIR="build"
          PKG_DIR="${BUILD_DIR}/${NAME}"
          ZIP_PATH="${BUILD_DIR}/${ZIP_NAME}"

          rm -rf "${PKG_DIR}" "${ZIP_PATH}"
          mkdir -p "${PKG_DIR}"
          cp -R "${SRC}/." "${PKG_DIR}/"
          mkdir -p "${PKG_DIR}/licenses"
          cp LICENSE.txt "${PKG_DIR}/licenses/LICENSE.txt"
          cp c-wspp-rs/LICENSE "${PKG_DIR}/licenses/LICENSE.c-wspp-rs.txt"
          cp c-wspp-rs/LICENSE.3rd-party.txt "${PKG_DIR}/licenses/LICENSE.c-wspp-rs.3rd-party.txt"
          cp build/licenses/cwspp-rs-THIRDPARTY.yaml "${PKG_DIR}/licenses/cwspp-rs-THIRDPARTY.yaml"
          rm -f \
            "${PKG_DIR}/LICENSE.txt" \
            "${PKG_DIR}/LICENSE.c-wspp-rs.txt" \
            "${PKG_DIR}/LICENSE.c-wspp-rs.3rd-party.txt" \
            "${PKG_DIR}/LICENSE.3rd-party.txt" \
            "${PKG_DIR}/cwspp-rs-THIRDPARTY.yaml"
          (cd "${BUILD_DIR}" && zip -r "${ZIP_NAME}" "${NAME}")

          echo "zip_path=${ZIP_PATH}" >> "${GITHUB_OUTPUT}"

      - name: Upload zip to draft release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.release_tag }}
          draft: true
          prerelease: false
          name: c-wspp-websocket-sharp ${{ needs.prepare-release.outputs.release_tag }}
          token: ${{ secrets.CWSPP_WEBSOCKET_SHARP_TOKEN }}
          files: |
              ${{ steps.pack.outputs.zip_path }}

  prepare-macos:
    name: prepare-macos
    runs-on: macos-15
    needs: prepare-release
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Setup Rust tools
        uses: baptiste0928/cargo-install@v3
        with:
          crate: cargo-bundle-licenses

      - name: Build universal macOS c-wspp-rs
        shell: bash
        run: |
          set -euo pipefail
          cargo build --release --manifest-path c-wspp-rs/Cargo.toml --target aarch64-apple-darwin
          cargo build --release --manifest-path c-wspp-rs/Cargo.toml --target x86_64-apple-darwin
          mkdir -p build/macos-prep
          lipo -create \
            c-wspp-rs/target/aarch64-apple-darwin/release/libc_wspp_rs.dylib \
            c-wspp-rs/target/x86_64-apple-darwin/release/libc_wspp_rs.dylib \
            -output build/macos-prep/c-wspp-macos-universal.dylib

      - name: Generate c-wspp-rs third-party license manifest
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build/macos-prep
          (
            cd c-wspp-rs
            cargo bundle-licenses --format yaml --output ../build/macos-prep/cwspp-rs-THIRDPARTY.yaml
          )

      - name: Upload prepare-macos artifacts
        uses: actions/upload-artifact@v4
        with:
          name: prepare-macos-assets
          path: |
            build/macos-prep/c-wspp-macos-universal.dylib
            build/macos-prep/cwspp-rs-THIRDPARTY.yaml

  build-macos:
    strategy:
      fail-fast: false
      matrix:
        os:
          - {managed_arch: arm64, os_id: macos-arm64}
        tfm: ["netstandard2.0", "net35"]
        include:
          - os: {managed_arch: x64, os_id: macos-x86_64}
            tfm: "net35"

    name: build-macos ${{ matrix.os.os_id }} ${{ matrix.tfm }}
    runs-on: macos-15
    needs:
      - prepare-release
      - prepare-macos
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Restore + clean
        run: |
          dotnet restore
          dotnet clean

      - name: Build websocket-sharp (managed arch)
        run: |
          dotnet build ./websocket-sharp/websocket-sharp.csproj -c Release -f ${{ matrix.tfm }} --arch ${{ matrix.os.managed_arch }}

      - name: Download prepare-macos artifacts
        uses: actions/download-artifact@v4
        with:
          name: prepare-macos-assets
          path: build/macos-prep

      - name: Create zip bundle
        id: pack
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ needs.prepare-release.outputs.release_tag }}"
          OS_ID="${{ matrix.os.os_id }}"
          TFM="${{ matrix.tfm }}"
          MANAGED_ARCH="${{ matrix.os.managed_arch }}"
          RID_DIR="osx-${MANAGED_ARCH}"
          NAME="c-wspp-websocket-sharp_${TAG}_${OS_ID}_${TFM}"
          ZIP_NAME="${NAME}.zip"

          SRC_RUNTIME="websocket-sharp/bin/Release/${TFM}/${RID_DIR}"
          SRC_UNIVERSAL="build/macos-prep/c-wspp-macos-universal.dylib"
          SRC_THIRDPARTY="build/macos-prep/cwspp-rs-THIRDPARTY.yaml"
          BUILD_DIR="build"
          PKG_DIR="${BUILD_DIR}/${NAME}"
          ZIP_PATH="${BUILD_DIR}/${ZIP_NAME}"

          rm -rf "${PKG_DIR}" "${ZIP_PATH}"
          mkdir -p "${PKG_DIR}"
          cp -R "${SRC_RUNTIME}/." "${PKG_DIR}/"
          cp "${SRC_UNIVERSAL}" "${PKG_DIR}/c-wspp-macos-universal.dylib"
          mkdir -p "${PKG_DIR}/licenses"
          cp LICENSE.txt "${PKG_DIR}/licenses/LICENSE.txt"
          cp c-wspp-rs/LICENSE "${PKG_DIR}/licenses/LICENSE.c-wspp-rs.txt"
          cp c-wspp-rs/LICENSE.3rd-party.txt "${PKG_DIR}/licenses/LICENSE.c-wspp-rs.3rd-party.txt"
          cp "${SRC_THIRDPARTY}" "${PKG_DIR}/licenses/cwspp-rs-THIRDPARTY.yaml"
          rm -f \
            "${PKG_DIR}/LICENSE.txt" \
            "${PKG_DIR}/LICENSE.c-wspp-rs.txt" \
            "${PKG_DIR}/LICENSE.c-wspp-rs.3rd-party.txt" \
            "${PKG_DIR}/LICENSE.3rd-party.txt" \
            "${PKG_DIR}/cwspp-rs-THIRDPARTY.yaml"
          (cd "${BUILD_DIR}" && zip -r "${ZIP_NAME}" "${NAME}")

          echo "zip_path=${ZIP_PATH}" >> "${GITHUB_OUTPUT}"

      - name: Upload zip to draft release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.release_tag }}
          draft: true
          prerelease: false
          name: c-wspp-websocket-sharp ${{ needs.prepare-release.outputs.release_tag }}
          token: ${{ secrets.CWSPP_WEBSOCKET_SHARP_TOKEN }}
          files: |
              ${{ steps.pack.outputs.zip_path }}
