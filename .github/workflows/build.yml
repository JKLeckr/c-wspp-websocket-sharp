name: Build

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Tag to publish draft release assets to (required for manual runs)"
        required: false
        type: string
  push:
    tags:
      - "v*"
      - "!*norel*"

jobs:
  prepare-release:
    name: prepare-release
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    outputs:
      release_tag: ${{ steps.meta.outputs.release_tag }}

    steps:
      - name: Resolve release tag
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            TAG="${GITHUB_REF_NAME}"
          else
            TAG="${{ github.event.inputs.release_tag }}"
          fi
          if [[ -z "${TAG}" ]]; then
            echo "No release tag available. For workflow_dispatch, provide inputs.release_tag."
            exit 1
          fi
          echo "release_tag=${TAG}" >> "${GITHUB_OUTPUT}"

      - name: Ensure draft release exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.meta.outputs.release_tag }}"
          if gh release view "${TAG}" >/dev/null 2>&1; then
            echo "Release ${TAG} already exists."
          else
            gh release create "${TAG}" \
              --draft \
              --title "${TAG}" \
              --notes "Automated draft release for ${TAG}"
          fi

  build-windows:
    strategy:
      fail-fast: false
      matrix:
        tfm: ["netstandard2.0", "net35"]

    name: build-windows ${{ matrix.tfm }}
    runs-on: windows-latest
    needs: prepare-release
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Restore + clean
        run: |
          dotnet restore
          dotnet clean

      - name: Build websocket-sharp
        run: |
          dotnet build .\websocket-sharp\websocket-sharp.csproj -c Release -f ${{ matrix.tfm }}

      - name: Create zip bundle
        id: pack
        shell: pwsh
        run: |
          $tag = "${{ needs.prepare-release.outputs.release_tag }}"
          $osId = "windows-x64"
          $tfm = "${{ matrix.tfm }}"
          $name = "c-wspp-websocket-sharp_${tag}_${osId}_${tfm}"
          $zipName = "$name.zip"

          $src = Join-Path $PWD "websocket-sharp/bin/Release/$tfm"
          $buildDir = Join-Path $PWD "build"
          $pkgDir = Join-Path $buildDir $name
          $zipPath = Join-Path $buildDir $zipName

          if (Test-Path $pkgDir) { Remove-Item $pkgDir -Recurse -Force }
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          New-Item -ItemType Directory -Force -Path $pkgDir | Out-Null

          Copy-Item (Join-Path $src '*') -Destination $pkgDir -Recurse -Force
          Compress-Archive -Path $pkgDir -DestinationPath $zipPath -Force

          "zip_path=$zipPath" >> $env:GITHUB_OUTPUT

      - name: Upload zip to draft release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          gh release upload "${{ needs.prepare-release.outputs.release_tag }}" "${{ steps.pack.outputs.zip_path }}" --clobber

  build-linux:
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-22.04", "ubuntu-24.04"]
        tfm: ["netstandard2.0", "net35"]

    name: build-linux ${{ matrix.os }} ${{ matrix.tfm }}
    runs-on: ${{ matrix.os }}
    needs: prepare-release
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Setup mono
        if: ${{ matrix.tfm == 'net35' }}
        run: |
          sudo apt update -y
          sudo apt install mono-complete -y

      - name: Restore + clean
        run: |
          dotnet restore
          dotnet clean

      - name: Build websocket-sharp
        run: |
          dotnet build ./websocket-sharp/websocket-sharp.csproj -c Release -f ${{ matrix.tfm }}

      - name: Create zip bundle
        id: pack
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ needs.prepare-release.outputs.release_tag }}"
          OS_ID="linux-x64"
          TFM="${{ matrix.tfm }}"
          NAME="c-wspp-websocket-sharp_${TAG}_${OS_ID}_${TFM}"
          ZIP_NAME="${NAME}.zip"

          SRC="websocket-sharp/bin/Release/${TFM}"
          BUILD_DIR="build"
          PKG_DIR="${BUILD_DIR}/${NAME}"
          ZIP_PATH="${BUILD_DIR}/${ZIP_NAME}"

          rm -rf "${PKG_DIR}" "${ZIP_PATH}"
          mkdir -p "${PKG_DIR}"
          cp -R "${SRC}/." "${PKG_DIR}/"
          (cd "${BUILD_DIR}" && zip -r "${ZIP_NAME}" "${NAME}")

          echo "zip_path=${ZIP_PATH}" >> "${GITHUB_OUTPUT}"

      - name: Upload zip to draft release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          gh release upload "${{ needs.prepare-release.outputs.release_tag }}" "${{ steps.pack.outputs.zip_path }}" --clobber

  build-macos:
    strategy:
      fail-fast: false
      matrix:
        include:
          - managed_arch: x64
            os_id: macos-x64
          - managed_arch: arm64
            os_id: macos-arm64
        tfm: ["netstandard2.0", "net35"]

    name: build-macos ${{ matrix.os_id }} ${{ matrix.tfm }}
    runs-on: macos-15
    needs: prepare-release
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Restore + clean
        run: |
          dotnet restore
          dotnet clean

      - name: Build websocket-sharp (managed arch)
        run: |
          dotnet build ./websocket-sharp/websocket-sharp.csproj -c Release -f ${{ matrix.tfm }} --arch ${{ matrix.managed_arch }}

      - name: Build universal macOS native library
        shell: bash
        run: |
          set -euo pipefail
          cargo build --release --manifest-path c-wspp-rs/Cargo.toml --target aarch64-apple-darwin
          cargo build --release --manifest-path c-wspp-rs/Cargo.toml --target x86_64-apple-darwin
          lipo -create \
            c-wspp-rs/target/aarch64-apple-darwin/release/libc_wspp_rs.dylib \
            c-wspp-rs/target/x86_64-apple-darwin/release/libc_wspp_rs.dylib \
            -output websocket-sharp/bin/Release/${{ matrix.tfm }}/c-wspp-macos-universal.dylib
          file websocket-sharp/bin/Release/${{ matrix.tfm }}/c-wspp-macos-universal.dylib

      - name: Create zip bundle
        id: pack
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ needs.prepare-release.outputs.release_tag }}"
          OS_ID="${{ matrix.os_id }}"
          TFM="${{ matrix.tfm }}"
          NAME="c-wspp-websocket-sharp_${TAG}_${OS_ID}_${TFM}"
          ZIP_NAME="${NAME}.zip"

          SRC="websocket-sharp/bin/Release/${TFM}"
          BUILD_DIR="build"
          PKG_DIR="${BUILD_DIR}/${NAME}"
          ZIP_PATH="${BUILD_DIR}/${ZIP_NAME}"

          rm -rf "${PKG_DIR}" "${ZIP_PATH}"
          mkdir -p "${PKG_DIR}"
          cp -R "${SRC}/." "${PKG_DIR}/"
          (cd "${BUILD_DIR}" && zip -r "${ZIP_NAME}" "${NAME}")

          echo "zip_path=${ZIP_PATH}" >> "${GITHUB_OUTPUT}"

      - name: Upload zip to draft release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          gh release upload "${{ needs.prepare-release.outputs.release_tag }}" "${{ steps.pack.outputs.zip_path }}" --clobber
